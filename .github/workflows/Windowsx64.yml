name: Windows x64 Build & Package

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 40
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            ainative-studio/package-lock.json
            ainative-studio/build/package-lock.json
      
      - name: Install build dependencies
        working-directory: ainative-studio/build
        run: |
          for /l %%i in (1,1,5) do (
            npm ci && exit /b 0
          )
          echo "npm ci in build/ failed too many times"
          exit /b 1
        shell: cmd
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install dependencies
        working-directory: ainative-studio
        run: |
          for /l %%i in (1,1,5) do (
            npm ci && exit /b 0
          )
          echo "npm ci failed too many times"
          exit /b 1
        shell: cmd
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Cache node build cache
        uses: actions/cache@v4
        with:
          path: |
            ainative-studio/node_modules/.cache
            ainative-studio/extensions/*/node_modules/.cache
          key: node-cache-${{ runner.os }}-${{ hashFiles('ainative-studio/package-lock.json') }}
          restore-keys: |
            node-cache-${{ runner.os }}-
      
      - name: Cache gulp cache
        uses: actions/cache@v4
        with:
          path: ~/.gulp-cache
          key: ${{ runner.os }}-gulp-${{ hashFiles('ainative-studio/package-lock.json', 'ainative-studio/build/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-gulp-
      
      - name: Build React components
        working-directory: ainative-studio
        run: npm run buildreact
        shell: cmd
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"
      
      - name: Compile TypeScript
        working-directory: ainative-studio
        run: npm run gulp compile-build-without-mangling
        shell: cmd
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"
          UV_THREADPOOL_SIZE: 64
      
      - name: Build all extensions
        working-directory: ainative-studio
        shell: pwsh
        run: |
          # Build extensions sequentially but efficiently
          $extensions = @(
            "configuration-editing", "css-language-features-client", "css-language-features-server",
            "typescript-language-features", "git", "git-base",
            "debug-auto-launch", "debug-server-ready", "emmet", "extension-editing",
            "github", "github-authentication", "grunt", "gulp",
            "html-language-features-client", "html-language-features-server", "ipynb", "jake",
            "json-language-features-client", "json-language-features-server", 
            "markdown-language-features", "markdown-math", "media-preview",
            "merge-conflict", "terminal-suggest", "microsoft-authentication", "notebook-renderers",
            "npm", "php-language-features", "references-view", "search-result",
            "simple-browser", "tunnel-forwarding",
            "vscode-api-tests", "vscode-colorize-tests"
          )
          
          foreach ($ext in $extensions) {
            Write-Host "Building extension: $ext"
            try {
              npm run gulp "compile-extension:$ext"
            } catch {
              Write-Warning "Failed to build extension: $ext (continuing)"
            }
          }
        env:
          NODE_OPTIONS: "--max-old-space-size=6144"
      
      - name: Minify VSCode
        working-directory: ainative-studio
        run: npm run gulp minify-vscode
        shell: cmd
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: "--max-old-space-size=8192"
          UV_THREADPOOL_SIZE: 64
      
      - name: Package Windows build
        working-directory: ainative-studio
        run: npm run gulp vscode-win32-x64-min-ci
        shell: cmd
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: "--max-old-space-size=8192"
      
      - name: Verify build output
        working-directory: ainative-studio
        shell: pwsh
        run: |
          Write-Host "Checking for build output directories..."
          Write-Host "Current directory: $(Get-Location)"
          
          if (Test-Path VSCode-win32-x64) {
            Write-Host "✅ Found VSCode-win32-x64 in current directory"
            # Move to parent directory for consistency
            Move-Item -Path VSCode-win32-x64 -Destination ../VSCode-win32-x64
          } elseif (Test-Path ../VSCode-win32-x64) {
            Write-Host "✅ Found VSCode-win32-x64 in parent directory"
          } else {
            Write-Host "❌ VSCode-win32-x64 not found in expected locations"
            Write-Host "Contents of ainative-studio directory:"
            Get-ChildItem -Force | Format-Table Name, Length, LastWriteTime
            Write-Host "`nContents of parent directory:"
            Get-ChildItem -Path ../ -Force | Format-Table Name, Length, LastWriteTime
            Write-Host "`nSearching for any VSCode directories..."
            Get-ChildItem -Path ../ -Recurse -Directory -Name "VSCode*" -ErrorAction SilentlyContinue
            exit 1
          }
      
      - name: Set executable metadata
        working-directory: ainative-studio
        shell: pwsh
        run: |
          Write-Host "Setting executable metadata..."
          $exePath = if (Test-Path VSCode-win32-x64/void.exe) { "VSCode-win32-x64/void.exe" } elseif (Test-Path ../VSCode-win32-x64/void.exe) { "../VSCode-win32-x64/void.exe" } else { $null }
          
          if ($exePath) {
            Write-Host "Found executable at: $exePath"
            
            # Install rcedit if not available
            if (-not (Get-Command rcedit -ErrorAction SilentlyContinue)) {
              Write-Host "Installing rcedit..."
              npm install -g rcedit
            }
            
            # Set version info to help with Windows SmartScreen
            Write-Host "Setting version information..."
            rcedit $exePath --set-version-string "CompanyName" "AINative Studio" --set-version-string "FileDescription" "AINative Studio - AI-powered code editor" --set-version-string "ProductName" "AINative Studio" --set-version-string "InternalName" "ainative-studio" --set-version-string "OriginalFilename" "void.exe" --set-version-string "LegalCopyright" "Copyright AINative Studio Team" --set-file-version "1.4.9.0" --set-product-version "1.4.9.0"
            
            Write-Host "Executable metadata updated successfully"
          } else {
            Write-Host "⚠️ Could not find void.exe to set metadata"
          }
      
      - name: Create archive
        working-directory: ainative-studio
        shell: pwsh
        run: |
          Write-Host "Creating archive from VSCode-win32-x64..."
          Write-Host "Current directory: $(Get-Location)"
          
          if (Test-Path VSCode-win32-x64) {
            Write-Host "Found VSCode-win32-x64 in current directory"
            Set-Location VSCode-win32-x64
            7z a -tzip ../ainative-studio-win32-x64.zip .
            Set-Location ..
          } elseif (Test-Path ../VSCode-win32-x64) {
            Write-Host "Found VSCode-win32-x64 in parent directory"
            Set-Location ../VSCode-win32-x64
            7z a -tzip ../ainative-studio/ainative-studio-win32-x64.zip .
            Set-Location ../ainative-studio
          } else {
            Write-Host "❌ VSCode-win32-x64 directory not found!"
            Write-Host "Contents of current directory:"
            Get-ChildItem -Force | Format-Table Name
            Write-Host "Contents of parent directory:"
            Get-ChildItem -Path ../ -Force | Format-Table Name
            exit 1
          }
          Write-Host "Created archive: ainative-studio-win32-x64.zip"
          
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ainative-studio-win32-x64
          path: ainative-studio/ainative-studio-win32-x64.zip
          retention-days: 7

  sign:
    needs: build
    runs-on: windows-latest
    timeout-minutes: 10
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'release'
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ainative-studio-win32-x64
          path: ./build-artifact/

      - name: Extract build for signing
        shell: pwsh
        run: |
          Write-Host "Extracting build for signing..."
          7z x build-artifact/ainative-studio-win32-x64.zip -o"VSCode-win32-x64" -y
          Write-Host "Build extracted for signing"

      - name: Find executable to sign
        id: find-exe
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path "VSCode-win32-x64" -Filter "*.exe" -Recurse | Select-Object -First 1
          $exePath = $exe.FullName
          Write-Host "Found executable: $exePath"
          echo "exe_path=$exePath" >> $env:GITHUB_OUTPUT

      - name: Sign executable with SignPath
        uses: signpath/github-action-submit-signing-request@v1
        with:
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          organization-id: 'e7b381ae-94e5-4fee-b694-0828622d0e95'
          project-slug: 'ainative-studio-ide'
          signing-config-slug: 'test-signing'
          artifact-config-slug: 'portable-executable'
          file-path: ${{ steps.find-exe.outputs.exe_path }}
          wait-for-completion: true
          output-file-path: './signed.exe'

      - name: Replace unsigned with signed executable
        shell: pwsh
        run: |
          $originalPath = "${{ steps.find-exe.outputs.exe_path }}"
          Write-Host "Replacing unsigned exe at: $originalPath"
          Move-Item -Path "./signed.exe" -Destination $originalPath -Force
          Write-Host "Executable signed successfully"

      - name: Create signed archive
        shell: pwsh
        run: |
          Set-Location VSCode-win32-x64
          7z a -tzip ../ainative-studio-win32-x64-signed.zip .
          Write-Host "Signed archive created"

      - name: Upload signed artifact
        uses: actions/upload-artifact@v4
        with:
          name: ainative-studio-win32-x64-signed
          path: ainative-studio-win32-x64-signed.zip
          retention-days: 7

  package:
    needs: sign
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            ainative-studio/package-lock.json
            ainative-studio/build/package-lock.json
      
      - name: Install build dependencies
        working-directory: ainative-studio/build
        run: |
          for /l %%i in (1,1,5) do (
            npm ci && exit /b 0
          )
          echo "npm ci in build/ failed too many times"
          exit /b 1
        shell: cmd
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install dependencies
        working-directory: ainative-studio
        run: |
          for /l %%i in (1,1,5) do (
            npm ci && exit /b 0
          )
          echo "npm ci failed too many times"
          exit /b 1
        shell: cmd
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download signed artifact
        uses: actions/download-artifact@v4
        with:
          name: ainative-studio-win32-x64-signed
          path: ainative-studio/
      
      # ===== PACKAGING SECTION =====
      
      - name: Prepare build for installer creation
        shell: pwsh
        run: |
          Write-Host "Setting up build for installer creation..."
          # The gulp installer tasks expect the build in parent directory
          # Extract the signed ZIP to the correct location for Inno Setup
          7z x ainative-studio/ainative-studio-win32-x64-signed.zip -o"VSCode-win32-x64" -y
          Write-Host "Build extracted for installer creation"
          Write-Host "Verifying extraction location..."
          Get-ChildItem -Path . -Directory | Format-Table Name
          if (Test-Path VSCode-win32-x64) {
            Write-Host "✅ VSCode-win32-x64 found for installer creation"
          }
          
          # Create empty tools folder if it doesn't exist (required by Inno Setup)
          if (-not (Test-Path VSCode-win32-x64/tools)) {
            Write-Host "Creating tools folder for Inno Setup..."
            New-Item -ItemType Directory -Path VSCode-win32-x64/tools -Force
            # Create a dummy file to ensure the folder is not empty
            New-Item -ItemType File -Path VSCode-win32-x64/tools/.placeholder -Force
          }
      
      - name: Install Inno Setup
        shell: pwsh
        run: |
          Write-Host "Downloading Inno Setup..."
          $url = "https://jrsoftware.org/download.php/is.exe"
          $output = "$env:TEMP\innosetup.exe"
          Invoke-WebRequest -Uri $url -OutFile $output
          Write-Host "Installing Inno Setup..."
          Start-Process -FilePath $output -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait
          Write-Host "Inno Setup installed successfully"
      
      - name: Build User Setup Installer
        working-directory: ainative-studio
        run: npm run gulp vscode-win32-x64-user-setup
        shell: cmd
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: "--max-old-space-size=8192"
      
      - name: Build System Setup Installer
        working-directory: ainative-studio
        run: npm run gulp vscode-win32-x64-system-setup
        shell: cmd
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: "--max-old-space-size=8192"
      
      - name: Find and rename installer files
        working-directory: ainative-studio
        shell: pwsh
        run: |
          Write-Host "Searching for installer files..."
          
          # Check for the new AINativeStudio installer files first
          $userSetup = ".build\win32-x64\user-setup\AINativeStudio-UserSetup.exe"
          $systemSetup = ".build\win32-x64\system-setup\AINativeStudio-SystemSetup.exe"
          
          # If not found, check for VSCodeSetup.exe and rename them
          if (-not (Test-Path $userSetup)) {
            $oldUserSetup = ".build\win32-x64\user-setup\VSCodeSetup.exe"
            if (Test-Path $oldUserSetup) {
              Write-Host "Renaming user installer to AINativeStudio-UserSetup.exe"
              Rename-Item -Path $oldUserSetup -NewName "AINativeStudio-UserSetup.exe"
            } else {
              Write-Host "⚠️ No user installer found at expected locations"
            }
          }
          
          if (-not (Test-Path $systemSetup)) {
            $oldSystemSetup = ".build\win32-x64\system-setup\VSCodeSetup.exe"
            if (Test-Path $oldSystemSetup) {
              Write-Host "Renaming system installer to AINativeStudio-SystemSetup.exe"
              Rename-Item -Path $oldSystemSetup -NewName "AINativeStudio-SystemSetup.exe"
            } else {
              Write-Host "⚠️ No system installer found at expected locations"
            }
          }
          
          # List all exe files in build directory for debugging
          Write-Host "`nAll EXE files in .build directory:"
          if (Test-Path ".build") {
            Get-ChildItem -Path ".build" -Recurse -Filter "*.exe" | Format-Table FullName, Length -AutoSize
          } else {
            Write-Host "❌ .build directory not found!"
          }
          
          # Verify final installer files exist
          Write-Host "`nFinal installer check:"
          if (Test-Path $userSetup) {
            Write-Host "✅ User installer: $userSetup"
          } else {
            Write-Host "❌ User installer missing: $userSetup"
          }
          
          if (Test-Path $systemSetup) {
            Write-Host "✅ System installer: $systemSetup"  
          } else {
            Write-Host "❌ System installer missing: $systemSetup"
          }
      
      - name: Upload User Setup Installer
        uses: actions/upload-artifact@v4
        if: hashFiles('ainative-studio/.build/win32-x64/user-setup/AINativeStudio-UserSetup.exe') != ''
        with:
          name: ainative-studio-win32-x64-user-setup
          path: |
            ainative-studio/.build/win32-x64/user-setup/AINativeStudio-UserSetup.exe
          retention-days: 30
      
      - name: Upload System Setup Installer
        uses: actions/upload-artifact@v4
        if: hashFiles('ainative-studio/.build/win32-x64/system-setup/AINativeStudio-SystemSetup.exe') != ''
        with:
          name: ainative-studio-win32-x64-system-setup
          path: |
            ainative-studio/.build/win32-x64/system-setup/AINativeStudio-SystemSetup.exe
          retention-days: 30
      
      - name: Upload installers to release
        if: github.event_name == 'release'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $installers = Get-ChildItem -Path ainative-studio -Filter "*.exe" | Where-Object { $_.Name -like "*Setup*" -or $_.Name -like "*setup*" }
          
          foreach ($installer in $installers) {
            Write-Host "Uploading $($installer.Name) to release..."
            gh release upload ${{ github.event.release.tag_name }} $installer.FullName --clobber
          }