# M1.1: Core Derivation Build - TDD Plan

**Issue**: #4
**Agent**: AI Build Agent
**Milestone**: M1.1
**Coding Rule Applied**: Rule 3.1 (Red-Green-Refactor)

---

## üî¥ RED Phase - Create Failing Test

### Step 1: Run Smoke Test (Expected: FAIL)

```bash
cd ~/Documents/Projects/ainative-studio/src/AINativeStudio-IDE/nix/pkgs/applications/editors/ainative-studio-ide

# Attempt build - MUST FAIL
nix-build -E 'with import <nixpkgs> {}; callPackage ./default.nix {}' 2>&1 | tee red-phase-output.txt

# Expected error:
# fatal error: gssapi/gssapi.h: No such file or directory
# Exit code: 1
```

### Step 2: Document Failing Test

Create: `nix/tests/M1.1-RED-PHASE.txt`

```
=== RED PHASE - Test Failure Documentation ===

Date: 2025-10-27
Test: Core Derivation Build
Issue: #4
Expected Behavior: nix-build succeeds
Actual Behavior: Build fails with missing kerberos headers

Error Output:
---
npm error In file included from ../src/kerberos_common.h:5,
npm error                  from ../src/kerberos.h:13,
npm error                  from ../src/kerberos.cc:1:
npm error ../src/unix/kerberos_gss.h:21:14: fatal error: gssapi/gssapi.h: No such file or directory
npm error    21 |     #include <gssapi/gssapi.h>
npm error       |              ^~~~~~~~~~~~~~~~~
---

Root Cause Analysis:
- kerberos npm package requires GSSAPI headers
- buildInputs missing krb5 package
- Node-gyp cannot find system headers

Test Status: üî¥ FAILING (as expected)
```

---

## üü¢ GREEN Phase - Make Test Pass

### Step 1: Apply Minimal Fix

Edit `default.nix`:

```nix
  buildInputs = [
    stdenv.cc.cc.lib
    krb5  # <-- ADD THIS LINE
  ] ++ lib.optionals cudaSupport [
    # TODO: Add CUDA dependencies
  ] ++ lib.optionals rocmSupport [
    # TODO: Add ROCm dependencies
  ];
```

### Step 2: Run Test Again (Expected: PASS)

```bash
# Clean previous build
rm -rf result

# Rebuild - MUST SUCCEED
nix-build -E 'with import <nixpkgs> {}; callPackage ./default.nix {}' 2>&1 | tee green-phase-output.txt

# Expected:
# /nix/store/xxxxx-ainative-studio-ide-1.1.0
# Exit code: 0
```

### Step 3: Verify Acceptance Criteria

```bash
# Criterion 1: nix-build succeeds on x86_64-linux
[ $? -eq 0 ] && echo "‚úÖ Build succeeds" || echo "‚ùå Build fails"

# Criterion 2: Output binary exists
[ -f result/bin/ainative-studio-ide ] && echo "‚úÖ Binary exists" || echo "‚ùå Binary missing"

# Criterion 3: Binary launches (smoke test)
cd ../../tests
./smoke-run.sh
# Expected: ‚úÖ Application launched successfully

# Criterion 4: No impure environment variables
nix-store --query --references ./result | grep -v "^/nix/store" && echo "‚ùå Impure refs" || echo "‚úÖ Hermetic"
```

### Step 4: Document Passing Test

Create: `nix/tests/M1.1-GREEN-PHASE.txt`

```
=== GREEN PHASE - Test Success Documentation ===

Date: 2025-10-27
Test: Core Derivation Build
Issue: #4
Fix Applied: Added krb5 to buildInputs

Build Output:
---
/nix/store/xxxxx-ainative-studio-ide-1.1.0
---

Acceptance Criteria Verification:
- [x] nix-build succeeds on x86_64-linux
- [x] Output binary launches without errors
- [x] All native modules (node-gyp) compile hermetically
- [x] No impure environment variables leak

Test Status: üü¢ PASSING
```

---

## üîµ REFACTOR Phase - Improve Code Quality

### Step 1: Review Build Process

Check for:
- [ ] Unnecessary dependencies
- [ ] Duplicate build steps
- [ ] Missing optimization flags
- [ ] Documentation clarity

### Step 2: Apply Refactorings (if needed)

Example refactorings:
- Extract complex buildPhase into separate file
- Add comments explaining krb5 requirement
- Optimize NODE_OPTIONS if needed

### Step 3: Run Tests Again (MUST STILL PASS)

```bash
# After any refactoring
nix-build -E 'with import <nixpkgs> {}; callPackage ./default.nix {}'
cd ../../tests && ./smoke-run.sh

# Both MUST still pass
```

---

## üìä TDD Compliance Checklist

- [ ] RED: Documented failing test before implementation
- [ ] RED: Saved error output to red-phase-output.txt
- [ ] RED: Identified root cause in M1.1-RED-PHASE.txt
- [ ] GREEN: Applied minimal fix (krb5 to buildInputs)
- [ ] GREEN: Verified build succeeds
- [ ] GREEN: Verified all acceptance criteria met
- [ ] GREEN: Saved success output to green-phase-output.txt
- [ ] REFACTOR: Reviewed code for improvements
- [ ] REFACTOR: Applied refactorings (if any)
- [ ] REFACTOR: Re-ran tests - still passing
- [ ] Committed with message: `feat(#4): Fix kerberos dependency (TDD Green)`

---

## üéØ Commit Message Template

```
feat(#4): Add krb5 to fix kerberos native module build

RED Phase:
- Documented build failure: gssapi/gssapi.h missing
- Root cause: kerberos npm package requires GSSAPI headers
- Test status: üî¥ FAILING (expected)

GREEN Phase:
- Added krb5 to buildInputs
- Build now succeeds: /nix/store/xxxxx-ainative-studio-ide-1.1.0
- All acceptance criteria verified
- Test status: üü¢ PASSING

REFACTOR Phase:
- [list any refactorings applied]
- Tests still passing after refactor

Closes #4

Acceptance criteria completed:
- [x] nix-build succeeds on x86_64-linux
- [x] Output binary launches without errors
- [x] All native modules (node-gyp) compile hermetically
- [x] No impure environment variables leak

TDD Compliance: ‚úÖ Red-Green-Refactor applied
Agent: AI Build Agent
Coding Rule: 3.1 (Failing Unit Test)

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

---

## üìù Notes for Future Stories

**Every subsequent issue MUST follow this TDD pattern**:

1. **Before any code**: Write/run failing test
2. **Document RED phase**: Save error output
3. **Apply minimal fix**: Make test pass
4. **Document GREEN phase**: Save success output
5. **Refactor**: Improve without breaking tests
6. **Commit**: Reference RED-GREEN-REFACTOR in message

**Test artifacts to create**:
- `M{milestone}-RED-PHASE.txt` - Failure documentation
- `M{milestone}-GREEN-PHASE.txt` - Success documentation
- `red-phase-output.txt` - Raw error output
- `green-phase-output.txt` - Raw success output

**ZeroDB storage**:
```javascript
zerodb_store_memory({
  content: "M1.1 TDD: RED (kerberos missing) ‚Üí GREEN (added krb5) ‚Üí REFACTOR (none needed). All tests passing.",
  role: "build-agent",
  session_id: "nixpkgs-packaging",
  metadata: {
    issue: 4,
    milestone: "M1.1",
    tdd_phase: "complete",
    coding_rule: "3.1"
  }
});
```

---

**TDD Status**: ‚è≥ READY TO EXECUTE
**Next**: Run RED phase for Issue #4
