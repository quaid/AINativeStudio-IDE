# M0.1 Hash Generation - Chain-of-Thought Reasoning

**Agent**: AI DevOps Agent
**Milestone**: M0.1 - Hash Generation & Prefetch
**Coding Rule Applied**: Rule 2.1 - Explain Coding Decision

---

## 1. Clarify Ambiguous Requirements

**What hashes are needed?**
- **Source hash**: For `fetchFromGitHub` to download the AINativeStudio-IDE repository
- **NPM dependencies hash**: For `buildNpmPackage` to cache npm dependencies hermetically

**Which version?**
- Target version: v1.1.0 (from PRD)
- Need to verify this tag exists in upstream repository
- Repository: `AINative-Studio/AINativeStudio-IDE`

**Subdirectory structure?**
- Main codebase is in `ainative-studio/` subdirectory
- `npmRoot = "ainative-studio"` in derivation
- `package.json` and `package-lock.json` are in this subdirectory

---

## 2. Weigh Alternative Approaches

### Option A: Use `nix-prefetch-github` (Recommended)
**Pros**:
- Official nixpkgs tool for GitHub source fetching
- Automatically handles SRI hash format
- Validates repository and tag exist
- Outputs ready-to-use hash

**Cons**:
- Requires network access (but that's acceptable for prefetch)
- May need to install tool if not in PATH

**Command**:
```bash
nix-prefetch-github AINative-Studio AINativeStudio-IDE --rev v1.1.0
```

### Option B: Manual tarball download + `nix-hash`
**Pros**:
- More control over process
- Can inspect tarball contents

**Cons**:
- More error-prone (wrong URL format, wrong hash type)
- Manual conversion to SRI format
- No validation of tag existence

**Command**:
```bash
wget https://github.com/AINative-Studio/AINativeStudio-IDE/archive/refs/tags/v1.1.0.tar.gz
nix-hash --type sha256 --base32 --flat v1.1.0.tar.gz
```

### Option C: Use `nix-prefetch-url --unpack`
**Pros**:
- Simpler than manual download
- Validates hash

**Cons**:
- Still requires constructing URL manually
- Less robust than nix-prefetch-github

**Chosen Approach**: **Option A** - Use `nix-prefetch-github`

**Rationale**: Most reliable, least error-prone, follows nixpkgs best practices

---

## 3. Consider Edge Cases, Performance, and Security

### Edge Cases

**Case 1: Tag format variations**
- Could be `v1.1.0` or `1.1.0`
- Solution: Try `v1.1.0` first (standard practice), verify in GitHub UI

**Case 2: Repository name mismatch**
- Repository might have changed name
- Solution: Verify URL: https://github.com/AINative-Studio/AINativeStudio-IDE

**Case 3: NPM dependencies hash - first build will fail**
- Expected behavior: First `nix-build` fails with "hash mismatch"
- Solution: Extract correct hash from error message
- Format: `got: sha256-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX`

**Case 4: Subdirectory affects npm hash**
- `npmDepsHash` must be calculated from `ainative-studio/` subdirectory
- Solution: Ensure `npmRoot = "ainative-studio"` is set in derivation

**Case 5: package-lock.json might be missing or stale**
- If no lock file, npm will generate one (non-deterministic)
- Solution: Verify package-lock.json exists in repo before prefetch

### Performance Considerations

- Hash generation is one-time cost per version
- Prefetch downloads ~200MB+ source tarball (VS Code fork is large)
- NPM deps hash requires building npm dependencies (~500MB+)
- Total time estimate: 5-10 minutes for both hashes

### Security Considerations

- Hashes ensure integrity - any tampering detected
- Using official GitHub tarball (not random mirror)
- SRI (Subresource Integrity) hash format is cryptographically secure
- No secrets or credentials needed for public repository

---

## 4. Chosen Implementation Plan

### Step 1: Verify repository and tag existence
```bash
# Check if tag exists via GitHub API
curl -s https://api.github.com/repos/AINative-Studio/AINativeStudio-IDE/git/refs/tags/v1.1.0
```

### Step 2: Generate source hash
```bash
cd ~/Documents/Projects/ainative-studio/src/AINativeStudio-IDE/nix/pkgs/applications/editors/ainative-studio-ide

# Generate hash
nix-prefetch-github AINative-Studio AINativeStudio-IDE --rev v1.1.0 > prefetch-output.json

# Extract hash from JSON
cat prefetch-output.json | jq -r .hash
# Or manually from output
```

### Step 3: Update default.nix with source hash
```nix
# In fetchFromGitHub block
hash = "sha256-XXXXX..."; # Replace with generated hash
```

### Step 4: Attempt build to get npmDepsHash error
```bash
nix-build -E 'with import <nixpkgs> {}; callPackage ./default.nix {}'
```

Expected error:
```
error: hash mismatch in fixed-output derivation '/nix/store/...':
  specified: sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
  got:       sha256-YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY=
```

### Step 5: Extract and update npmDepsHash
```bash
# Copy the "got:" hash from error message
# Update default.nix
npmDepsHash = "sha256-YYYYY...";
```

### Step 6: Verify both hashes with clean build
```bash
# Clean any previous attempts
rm -rf result

# Build should now succeed (or fail for different reason)
nix-build -E 'with import <nixpkgs> {}; callPackage ./default.nix {}'
```

### Step 7: Store results in ZeroDB
```javascript
zerodb_store_memory({
  content: "M0.1 Complete: Generated hashes for v1.1.0. Source hash: sha256-XXX, npmDepsHash: sha256-YYY. Used nix-prefetch-github for reliability. Edge cases handled: verified tag exists, extracted npm hash from error message, confirmed ainative-studio subdirectory structure.",
  role: "devops-agent",
  session_id: "nixpkgs-packaging",
  metadata: {
    milestone: "M0",
    task: "hash-generation",
    status: "complete",
    version: "1.1.0"
  }
});
```

### Step 8: Commit changes
```bash
git add nix/pkgs/applications/editors/ainative-studio-ide/default.nix
git commit -m "feat(M0.1): Generate source and npm dependency hashes for v1.1.0

- Source hash: sha256-XXX (via nix-prefetch-github)
- npmDepsHash: sha256-YYY (extracted from build error)
- Verified tag v1.1.0 exists in upstream repository
- Confirmed ainative-studio subdirectory structure

This unblocks AI Build Agent for M1 derivation implementation.

Milestone: M0.1 ✓
Next: M1.1 (Core derivation build)"
```

---

## 5. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Tag v1.1.0 doesn't exist | Low | High | Check GitHub releases before prefetch |
| npm dependencies change between attempts | Low | Medium | Use package-lock.json for determinism |
| Network timeout during prefetch | Medium | Low | Retry with exponential backoff |
| Wrong subdirectory path | Low | High | Verify package.json location first |
| Hash format incompatibility | Low | Medium | Use SRI format (sha256-...) consistently |

---

## 6. Success Criteria

- [x] Chain-of-thought reasoning documented (this file)
- [ ] Source hash generated successfully
- [ ] npmDepsHash extracted from build error
- [ ] Both hashes updated in default.nix
- [ ] Clean build attempt validates hashes
- [ ] Changes committed to feature branch
- [ ] Results stored in ZeroDB
- [ ] AI Build Agent unblocked for M1.1

---

**Next Step**: Execute the implementation plan above

**Self-Validation Checklist** (Rule 7):
1. ✓ Chain-of-thought provided before code generation
2. ⏳ Implementation follows reasoning steps
3. ⏳ Edge cases documented in inline comments
4. ⏳ Results stored in ZeroDB for team

---

**Generated by**: AI DevOps Agent
**Coding Rule**: Rule 2.1 (Chain-of-Thought Reasoning)
**Date**: 2025-10-27
