# M0.1 Manual Execution Instructions

**Agent**: AI DevOps Agent
**Milestone**: M0.1 - Hash Generation
**Status**: Ready to Execute (Requires Nix Installation)

---

## Prerequisites

You need a system with Nix installed. Options:

### Option 1: Use NixOS or Nix-enabled Linux
```bash
# If Nix not installed, install it:
curl -L https://nixos.org/nix/install | sh
source ~/.nix-profile/etc/profile.d/nix.sh
```

### Option 2: Use GitHub Codespaces with Nix
```bash
# In a GitHub Codespace:
curl -L https://nixos.org/nix/install | sh --no-daemon
```

### Option 3: Use Docker with Nix
```bash
docker run -it -v $(pwd):/workspace nixos/nix
cd /workspace
```

---

## Automated Execution

If you have Nix installed, run the automated script:

```bash
cd ~/Documents/Projects/ainative-studio/src/AINativeStudio-IDE/nix
./M0.1-EXECUTION-COMMANDS.sh
```

This script will:
1. ‚úÖ Verify tag v1.1.0 exists
2. ‚úÖ Generate source hash via `nix-prefetch-github` or `nix-prefetch-url`
3. ‚úÖ Update `default.nix` with source hash
4. ‚úÖ Attempt build to extract npmDepsHash from error
5. ‚úÖ Update `default.nix` with npmDepsHash
6. ‚úÖ Verify with clean build
7. ‚úÖ Generate M0.1-RESULTS.txt summary

---

## Manual Step-by-Step (If Script Fails)

### Step 1: Generate Source Hash

```bash
cd ~/Documents/Projects/ainative-studio/src/AINativeStudio-IDE/nix/pkgs/applications/editors/ainative-studio-ide

# Method A: Using nix-prefetch-github (preferred)
nix-shell -p nix-prefetch-github --run "nix-prefetch-github AINative-Studio AINativeStudio-IDE --rev v1.1.0"

# Method B: Using nix-prefetch-url
nix-prefetch-url --unpack "https://github.com/AINative-Studio/AINativeStudio-IDE/archive/refs/tags/v1.1.0.tar.gz"
# Then convert to SRI format:
# nix-hash --to-sri --type sha256 <hash-from-above>
```

**Copy the hash** (format: `sha256-XXXXX...`)

### Step 2: Update default.nix - Source Hash

Edit `default.nix`, find the `fetchFromGitHub` block:

```nix
src = fetchFromGitHub {
  owner = "AINative-Studio";
  repo = "AINativeStudio-IDE";
  rev = "v${version}";
  hash = "sha256-PASTE_SOURCE_HASH_HERE";  # ‚Üê Update this line
};
```

### Step 3: Attempt Build (Will Fail - Expected!)

```bash
nix-build -E 'with import <nixpkgs> {}; callPackage ./default.nix {}' 2>&1 | tee build-error.txt
```

**Expected error**:
```
error: hash mismatch in fixed-output derivation '/nix/store/...npm-deps-...':
  specified: sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
  got:       sha256-YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY=
```

### Step 4: Extract npmDepsHash

From the error output, copy the "got:" hash:

```bash
grep "got:" build-error.txt
# Output: got:       sha256-Bh9JaB...
```

### Step 5: Update default.nix - NPM Hash

Edit `default.nix`, find the `npmDepsHash` line:

```nix
# npm dependencies hash - needs to be generated
npmDepsHash = "sha256-PASTE_NPM_HASH_HERE";  # ‚Üê Update this line
```

### Step 6: Verify Clean Build

```bash
rm -rf result

# This should now succeed (or fail for different reason if derivation has other issues)
nix-build -E 'with import <nixpkgs> {}; callPackage ./default.nix {}'
```

If successful:
```
/nix/store/XXXXX-ainative-studio-ide-1.1.0
```

---

## Expected Results

After completion, you should have:

1. **Updated `default.nix`** with both hashes:
   - `hash = "sha256-..."`  (fetchFromGitHub)
   - `npmDepsHash = "sha256-..."`  (buildNpmPackage)

2. **Build artifact** (if build succeeds):
   - `./result` symlink pointing to `/nix/store/...-ainative-studio-ide-1.1.0`

3. **M0.1-RESULTS.txt** summary file with:
   - Both hashes
   - Commit SHA
   - Verification status

---

## Troubleshooting

### "nix-prefetch-github: command not found"

Install in a nix-shell:
```bash
nix-shell -p nix-prefetch-github
```

Or use the alternative method (nix-prefetch-url).

### "error: file 'nixpkgs' was not found"

Set NIX_PATH:
```bash
export NIX_PATH=nixpkgs=https://github.com/NixOS/nixpkgs/archive/nixos-unstable.tar.gz
```

### Build fails with compilation errors

This is expected if the derivation has other issues. M0.1 only focuses on hash generation. Document the errors and proceed to commit the hashes - the Build Agent (M1) will fix compilation issues.

### Hash mismatch persists after update

- Verify you copied the full hash (starts with `sha256-` and is ~44 characters)
- Ensure you updated the correct line (not a comment)
- Try deleting `~/.cache/nix` to clear any cached attempts

---

## After Completion

### 1. Commit Changes

```bash
git add pkgs/applications/editors/ainative-studio-ide/default.nix
git commit -m "feat(M0.1): Generate source and npm dependency hashes for v1.1.0

- Source hash: $(grep 'hash =' default.nix | awk '{print $3}')
- npmDepsHash: $(grep 'npmDepsHash =' default.nix | awk '{print $3}')
- Verified tag v1.1.0 exists (commit: 5b89e1873abc...)
- Extracted npm hash from build error output

Generated using:
- nix-prefetch-github for source tarball
- buildNpmPackage error message for npm deps

This unblocks AI Build Agent for M1.1 core derivation.

Milestone: M0.1 ‚úì
Next: M1.1 (Core derivation build)
Agent: AI DevOps
Coding Rule: Rule 2.1 (Chain-of-thought applied)

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

### 2. Store in ZeroDB

```javascript
zerodb_store_memory({
  content: "M0.1 Complete: Generated hashes for v1.1.0. Source hash: [paste hash], npmDepsHash: [paste hash]. Used nix-prefetch-github for source, extracted npm hash from build error. Verified tag exists, confirmed ainative-studio subdirectory structure.",
  role: "devops-agent",
  session_id: "nixpkgs-packaging",
  metadata: {
    milestone: "M0",
    task: "hash-generation",
    status: "complete",
    version: "1.1.0",
    source_hash: "[paste here]",
    npm_hash: "[paste here]"
  }
});
```

### 3. Update Task Status

Edit `nix/AGENT_TASKS.md` - M0.1 section:
- [x] Generate source hash
- [x] Generate npmDepsHash
- [x] Update default.nix
- [x] Verify hashes
- [x] Commit changes
- [x] Store in ZeroDB

### 4. Notify Build Agent

Update `nix/AGENT_TASKS.md` - add note:
```markdown
## M0.1 Status: ‚úÖ COMPLETE

**Hashes Generated**:
- Source: sha256-XXX...
- NPM Deps: sha256-YYY...

**AI Build Agent**: M1.1 is now UNBLOCKED. Begin core derivation implementation.
```

---

## Summary

**M0.1 Critical Path**: Hash Generation ‚úÖ

This milestone is the **blocker** for all subsequent work. Once hashes are in `default.nix`:
- ‚úÖ AI Build Agent can implement M1.1 (core derivation)
- ‚úÖ All subsequent agents can proceed on critical path

**Estimated Time**: 10-15 minutes (with Nix installed)

**Required Tools**:
- Nix package manager
- nix-prefetch-github or nix-prefetch-url
- jq (for JSON parsing)
- Standard Unix tools (grep, awk, sed)

---

**Status**: READY TO EXECUTE
**Blocker**: Requires Nix installation
**Next**: Run `M0.1-EXECUTION-COMMANDS.sh` on Nix-enabled system
